version: '3.8'

services:
  # =====================================================
  # DATABASES
  # =====================================================

  mysql-vehicle:
    image: mysql:8.0
    container_name: gdldv-mysql-vehicle
    environment:
      MYSQL_DATABASE: ${VEHICLE_DB_NAME:-gdldv_vehicle_db}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_USER: ${MYSQL_USER:-gdldv_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-gdldv_password}
    ports:
      - "3307:3306"
    volumes:
      - mysql-vehicle-data:/var/lib/mysql
      - ./db-init/vehicle-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - gdldv-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-rootpassword}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  mysql-reservation:
    image: mysql:8.0
    container_name: gdldv-mysql-reservation
    environment:
      MYSQL_DATABASE: ${RESERVATION_DB_NAME:-gdldv_reservation_db}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_USER: ${MYSQL_USER:-gdldv_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-gdldv_password}
    ports:
      - "3308:3306"
    volumes:
      - mysql-reservation-data:/var/lib/mysql
      - ./db-init/reservation-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - gdldv-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-rootpassword}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  mysql-user:
    image: mysql:8.0
    container_name: gdldv-mysql-user
    environment:
      MYSQL_DATABASE: ${USER_DB_NAME:-gdldv_user_db}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_USER: ${MYSQL_USER:-gdldv_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-gdldv_password}
    ports:
      - "3309:3306"
    volumes:
      - mysql-user-data:/var/lib/mysql
      - ./db-init/user-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - gdldv-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-rootpassword}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  mysql-rental:
    image: mysql:8.0
    container_name: gdldv-mysql-rental
    environment:
      MYSQL_DATABASE: ${RENTAL_DB_NAME:-gdldv_rental_db}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_USER: ${MYSQL_USER:-gdldv_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-gdldv_password}
    ports:
      - "3310:3306"
    volumes:
      - mysql-rental-data:/var/lib/mysql
      - ./db-init/rental-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - gdldv-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-rootpassword}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # =====================================================
  # CACHE & MESSAGING
  # =====================================================

  redis:
    image: redis:7-alpine
    container_name: gdldv-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - gdldv-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # =====================================================
  # INFRASTRUCTURE SERVICES
  # =====================================================

  eureka-server:
    build:
      context: ./eureka-server
      dockerfile: Dockerfile
    container_name: gdldv-eureka-server
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
    networks:
      - gdldv-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  config-server:
    build:
      context: .
      dockerfile: config-server/Dockerfile
    container_name: gdldv-config-server
    ports:
      - "8888:8888"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    networks:
      - gdldv-network
    depends_on:
      eureka-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8888/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: gdldv-api-gateway
    ports:
      - "8000:8000"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-me-in-production-gdldv-2025}
    networks:
      - gdldv-network
    depends_on:
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped

  # =====================================================
  # BUSINESS SERVICES
  # =====================================================

  vehicle-service:
    build:
      context: ./vehicle-service
      dockerfile: Dockerfile
    container_name: gdldv-vehicle-service
    ports:
      - "8001:8001"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-vehicle:3306/${VEHICLE_DB_NAME:-gdldv_vehicle_db}?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER:-gdldv_user}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD:-gdldv_password}
    networks:
      - gdldv-network
    depends_on:
      mysql-vehicle:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8001/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped

  reservation-service:
    build:
      context: ./reservation-service
      dockerfile: Dockerfile
    container_name: gdldv-reservation-service
    ports:
      - "8002:8002"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-reservation:3306/${RESERVATION_DB_NAME:-gdldv_reservation_db}?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER:-gdldv_user}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD:-gdldv_password}
      - STRIPE_API_KEY=${STRIPE_API_KEY:-sk_test_your_stripe_key}
    networks:
      - gdldv-network
    depends_on:
      mysql-reservation:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      vehicle-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8002/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped

  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: gdldv-user-service
    ports:
      - "8003:8003"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-user:3306/${USER_DB_NAME:-gdldv_user_db}?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER:-gdldv_user}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD:-gdldv_password}
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
      - SPRING_CACHE_TYPE=redis
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-me-in-production-gdldv-2025}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-86400000}
    networks:
      - gdldv-network
    depends_on:
      mysql-user:
        condition: service_healthy
      redis:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8003/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped

  rental-service:
    build:
      context: .
      dockerfile: rental-service/Dockerfile
    container_name: gdldv-rental-service
    ports:
      - "8004:8004"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-rental:3306/${RENTAL_DB_NAME:-gdldv_rental_db}?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER:-gdldv_user}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD:-gdldv_password}
      - SPRING_MAIL_HOST=${MAIL_HOST:-smtp.gmail.com}
      - SPRING_MAIL_PORT=${MAIL_PORT:-587}
      - SPRING_MAIL_USERNAME=${MAIL_USERNAME:-your-email@gmail.com}
      - SPRING_MAIL_PASSWORD=${MAIL_PASSWORD:-your-app-password}
    networks:
      - gdldv-network
    depends_on:
      mysql-rental:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      vehicle-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
      reservation-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8004/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped

  # =====================================================
  # FRONTEND
  # =====================================================

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: gdldv-frontend
    ports:
      - "3000:80"
    environment:
      - NODE_ENV=production
      - VITE_API_URL=http://localhost:8000
    networks:
      - gdldv-network
    depends_on:
      api-gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

# =====================================================
# NETWORKS
# =====================================================
networks:
  gdldv-network:
    driver: bridge
    name: gdldv-network

# =====================================================
# VOLUMES
# =====================================================
volumes:
  mysql-vehicle-data:
    name: gdldv-mysql-vehicle-data
  mysql-reservation-data:
    name: gdldv-mysql-reservation-data
  mysql-user-data:
    name: gdldv-mysql-user-data
  mysql-rental-data:
    name: gdldv-mysql-rental-data
  redis-data:
    name: gdldv-redis-data
